stages:
  - test
  - build
  - publish

variables:
  GO_COLLECTOR_NAME: "sqm-go-collector"
  GO_COLLECTOR_DIR: "sqm-go-collector"

sqm_tests:
  stage: test
  image: golang:1.22
  script:
    - bash tests/run-tests.sh

go_collector_build:
  stage: build
  image: golang:1.22
  script:
    - mkdir -p dist
    - cd "${GO_COLLECTOR_DIR}"
    - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w" -o "../dist/${GO_COLLECTOR_NAME}-linux-amd64" "./cmd/${GO_COLLECTOR_NAME}"
    - CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -ldflags="-s -w" -o "../dist/${GO_COLLECTOR_NAME}-linux-arm64" "./cmd/${GO_COLLECTOR_NAME}"
    - CGO_ENABLED=0 GOOS=linux GOARCH=mipsle GOMIPS=softfloat go build -trimpath -ldflags="-s -w" -o "../dist/${GO_COLLECTOR_NAME}-linux-mipsle-softfloat" "./cmd/${GO_COLLECTOR_NAME}"
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-go-collector"
    paths:
      - dist/
    expire_in: 1 week

go_collector_publish_package:
  stage: publish
  image: alpine:3.20
  needs:
    - job: go_collector_build
      artifacts: true
  before_script:
    - apk add --no-cache curl
  script:
    - PACKAGE_VERSION="${CI_COMMIT_TAG:-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}}"
    - |
      for file in dist/${GO_COLLECTOR_NAME}-linux-*; do
        curl --fail --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file "${file}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${GO_COLLECTOR_NAME}/${PACKAGE_VERSION}/$(basename "${file}")"
      done
    - 'echo "Published package version: ${PACKAGE_VERSION}"'
    - 'echo "Base URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${GO_COLLECTOR_NAME}/${PACKAGE_VERSION}"'
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH'
